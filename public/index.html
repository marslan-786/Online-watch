<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stream</title>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #e50914; --dark: #000; --text: #fff; }
        body { background-color: var(--dark); color: var(--text); font-family: sans-serif; margin: 0; padding: 0; overflow: hidden; height: 100vh; width: 100vw; }
        
        .hidden { display: none !important; }
        .center-flex { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; width: 100%; z-index: 200; position: relative; }

        /* --- üî• FIX: FULL SCREEN VIDEO --- */
        #player-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: black; z-index: 10;
        }
        .video-wrapper { 
            width: 100%; height: 100%; 
            display: flex; align-items: center; justify-content: center; 
        }
        /* €å€Å ŸÑÿßÿ¶ŸÜ Ÿà€å⁄à€åŸà ⁄©Ÿà ÿ≥⁄©ÿ±€åŸÜ Ÿæÿ± ŸÅŸπ ⁄©ÿ±€í ⁄Ø€å ÿßŸàÿ± Ÿæ⁄Ü⁄©ŸÜ€í ŸÜ€Å€å⁄∫ ÿØ€í ⁄Ø€å */
        video { 
            width: 100%; height: 100%; 
            object-fit: contain !important; 
        }
        /* Plyr Fixes */
        .plyr { width: 100%; height: 100%; }
        .plyr__video-wrapper { width: 100%; height: 100%; }

        /* UI Elements (Floating) */
        .box { background: rgba(30,30,30,0.9); padding: 20px; border-radius: 10px; width: 80%; max-width: 350px; text-align: center; border: 1px solid #444; backdrop-filter: blur(5px); }
        input { width: 100%; padding: 10px; margin: 10px 0; background: #222; border: 1px solid #555; color: white; border-radius: 5px; box-sizing: border-box; }
        .btn { background: var(--primary); color: white; border: none; padding: 10px; width: 100%; border-radius: 5px; font-weight: bold; margin-top: 5px; }

        /* Top Bar */
        .top-bar { position: absolute; top: 0; left: 0; width: 100%; padding: 10px; display: flex; justify-content: flex-end; z-index: 100; box-sizing: border-box; pointer-events: none; }
        .icon-btn { width: 40px; height: 40px; background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; pointer-events: auto; margin-left: 10px; }
        #mic-btn.active { background: #00e676; color: black; box-shadow: 0 0 15px #00e676; }

        /* Glass Shield for Users */
        #glass-shield { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; display: none; }
        body:not(.is-admin) #glass-shield { display: block; }
        body:not(.is-admin) .plyr__controls { display: none !important; } /* Hide user controls */

        /* Quality Modal */
        #quality-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 300; display: flex; align-items: center; justify-content: center; }
        .q-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .q-btn { background: #333; color: white; border: 1px solid #555; padding: 15px; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="lobby-screen" class="center-flex">
        <div class="box">
            <h2 style="color:var(--primary); margin:0;">üî¥ LIVE STREAM</h2>
            <input type="text" id="linkInput" placeholder="Paste YouTube Link...">
            <button class="btn" onclick="fetchInfo()">Load Stream</button>
            <p id="status-text" style="color:#aaa; font-size:12px; margin-top:10px;"></p>
        </div>
    </div>

    <div id="quality-modal" class="hidden">
        <div class="box">
            <h3>Select Quality</h3>
            <div class="q-grid">
                <button class="q-btn" onclick="selectQuality('1080')">1080p</button>
                <button class="q-btn" onclick="selectQuality('720')">720p</button>
                <button class="q-btn" onclick="selectQuality('480')">480p</button>
                <button class="q-btn" onclick="selectQuality('audio')">Audio Only</button>
            </div>
        </div>
    </div>

    <div id="link-screen" class="center-flex hidden">
        <div class="box">
            <h3>Stream Ready!</h3>
            <input type="text" id="share-link-input" readonly onclick="this.select()">
            <button class="btn" onclick="copyLink()">Copy Link</button>
            <button class="btn" onclick="enterCinema()">Start Broadcasting</button>
        </div>
    </div>

    <div id="player-screen" class="hidden">
        <div class="top-bar">
            <div class="icon-btn" id="mic-btn" onclick="toggleMic()"><i class="fas fa-microphone-slash"></i></div>
            <div class="icon-btn admin-only" onclick="copyLink()"><i class="fas fa-link"></i></div>
        </div>

        <div class="video-wrapper">
            <div id="glass-shield"></div>
            <video id="player" playsinline controls crossorigin></video>
        </div>

        <div id="audio-grid"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <script>
        const socket = io();
        const urlParams = new URLSearchParams(window.location.search);
        let roomId = urlParams.get('room');
        let player, amIAdmin = false;
        let currentUrl = '';

        // --- üî• VOICE MESH SYSTEM ---
        let peer, myStream, myPeerId;
        const peers = {}; // Keep track of calls

        function initVoice() {
            peer = new Peer(undefined, {
                host: window.location.hostname,
                port: window.location.port || (window.location.protocol === 'https:' ? 443 : 80),
                path: '/peerjs/myapp'
            });

            peer.on('open', id => {
                myPeerId = id;
            });

            // ANSWER CALLS (From others)
            peer.on('call', call => {
                call.answer(myStream); // Answer with my audio
                const audio = document.createElement('audio');
                call.on('stream', stream => addAudioStream(audio, stream));
            });

            // When I join voice, server sends list of EXISTING users
            socket.on('all_voice_users', (users) => {
                users.forEach(userId => {
                    if(userId !== myPeerId) connectToUser(userId);
                });
            });

            // When SOMEONE ELSE joins voice
            socket.on('user_joined_voice', userId => {
                connectToUser(userId);
            });
        }

        function toggleMic() {
            const btn = document.getElementById('mic-btn');
            if(myStream) {
                // MUTE
                myStream.getTracks().forEach(t => t.stop());
                myStream = null;
                btn.classList.remove('active');
            } else {
                // UNMUTE
                navigator.mediaDevices.getUserMedia({ audio: true, video: false }).then(stream => {
                    myStream = stream;
                    btn.classList.add('active');
                    
                    // 1. Tell server I'm ready
                    if(roomId) socket.emit('join_voice', { roomId, peerId: myPeerId });
                    
                    // 2. Init logic happens in socket events above

                }).catch(e => alert("Mic Access Denied!"));
            }
        }

        function connectToUser(userId) {
            if(!myStream) return; // Only call if I have mic on (or create silent stream)
            const call = peer.call(userId, myStream);
            const audio = document.createElement('audio');
            call.on('stream', stream => addAudioStream(audio, stream));
            peers[userId] = call;
        }

        function addAudioStream(audio, stream) {
            audio.srcObject = stream;
            audio.autoplay = true;
            document.body.append(audio);
        }

        // --- APP LOGIC ---
        if(roomId) {
            document.getElementById('lobby-screen').classList.add('hidden');
            document.getElementById('player-screen').classList.remove('hidden');
            socket.emit('join_room', roomId);
            initVoice(); // Prepare PeerJS
        }

        function fetchInfo() {
            const link = document.getElementById('linkInput').value;
            if(!link) return;
            if(!roomId) {
                roomId = Math.random().toString(36).substring(7);
                window.history.pushState({}, '', `?room=${roomId}`);
                socket.emit('join_room', roomId);
                initVoice();
            }
            socket.emit('get_video_info', { roomId, url: link });
            document.getElementById('status-text').innerText = "Processing...";
        }

        socket.on('show_quality_menu', (data) => {
            currentUrl = data.url;
            document.getElementById('quality-modal').classList.remove('hidden');
        });

        function selectQuality(q) {
            document.getElementById('quality-modal').classList.add('hidden');
            document.getElementById('status-text').innerText = "Downloading...";
            socket.emit('start_download', { roomId, url: currentUrl, quality: q });
        }

        socket.on('download_complete', (data) => {
            if(amIAdmin) {
                document.getElementById('lobby-screen').classList.add('hidden');
                document.getElementById('link-screen').classList.remove('hidden');
                document.getElementById('share-link-input').value = window.location.href;
            }
        });

        function enterCinema() {
            document.getElementById('link-screen').classList.add('hidden');
            document.getElementById('player-screen').classList.remove('hidden');
        }

        // --- PLAYER INIT & SYNC ---
        socket.on('sync_immediate', (data) => {
            if(data.filename) initPlayer(data.filename, data.time, data.isPlaying);
        });

        socket.on('update_room_data', (room) => {
            amIAdmin = room.admins.includes(socket.id);
            if(amIAdmin) document.body.classList.add('is-admin');
            
            if(room.status === 'ready' && !player && !document.getElementById('link-screen').classList.contains('hidden')) {
                // If user is late, auto show player
                document.getElementById('lobby-screen').classList.add('hidden');
                document.getElementById('player-screen').classList.remove('hidden');
                initPlayer(room.videoFilename, room.currentTime, room.isPlaying);
            }
        });

        function initPlayer(filename, startTime, isPlaying) {
            if(player) return;
            
            player = new Plyr('#player', { 
                controls: amIAdmin ? ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'fullscreen'] : [],
                clickToPlay: amIAdmin,
                ratio: '16:9'
            });

            player.source = { type: 'video', sources: [{ src: `/stream/${filename}`, type: 'video/mp4' }] };
            
            player.on('ready', () => {
                player.currentTime = startTime;
                if(isPlaying || !amIAdmin) player.play(); // Auto play for everyone
            });

            // Admin updates server time periodically
            if(amIAdmin) {
                setInterval(() => { if(!player.paused) socket.emit('time_update', { roomId, time: player.currentTime }); }, 1000);
            }
        }
        
        function copyLink() { navigator.clipboard.writeText(window.location.href); alert("Copied"); }
    </script>
</body>
</html>
