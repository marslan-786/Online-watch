<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stream Engine</title>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #00e676; --bg: #000; }
        body { background: var(--bg); color: white; margin: 0; height: 100vh; overflow: hidden; font-family: sans-serif; }
        .hidden { display: none !important; }
        .center-flex { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; width: 100%; }
        
        .ui-box { position: relative; z-index: 100; background: rgba(20,20,20,0.9); padding: 25px; border-radius: 12px; border: 1px solid #333; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 0 30px rgba(0,0,0,0.7); }
        input { width: 100%; padding: 12px; margin: 15px 0; background: #111; border: 1px solid #555; color: white; text-align: center; border-radius: 5px; box-sizing: border-box; }
        .btn { background: var(--primary); color: black; border: none; padding: 12px; width: 100%; font-weight: bold; cursor: pointer; border-radius: 5px; font-size: 16px; margin-top: 10px; }
        
        /* Progress Bar */
        .progress-container { width: 100%; background: #333; height: 15px; border-radius: 10px; margin: 20px 0; overflow: hidden; border: 1px solid #555; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s ease-out; box-shadow: 0 0 10px var(--primary); }
        #percent-text { font-size: 28px; font-weight: bold; color: var(--primary); text-shadow: 0 0 10px rgba(0,230,118,0.5); }

        #player-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; background: black; }
        video { width: 100%; height: 100%; object-fit: contain; }
        #glass-shield { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; display: none; }
        body:not(.is-admin) #glass-shield { display: block; }

        #admin-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; z-index: 50; background: rgba(20,20,20,0.9); padding: 10px 20px; border-radius: 30px; border: 1px solid #444; }
        #mic-btn { position: fixed; top: 20px; right: 20px; z-index: 100; width: 50px; height: 50px; border-radius: 50%; background: rgba(255,0,0,0.8); color: white; border: 2px solid white; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; }
        #mic-btn.active { background: var(--primary); border-color: var(--primary); box-shadow: 0 0 15px var(--primary); }
        .admin-only { display: none !important; }
        body.is-admin .admin-only { display: flex !important; }
        
        .q-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .q-btn { background: #333; padding: 15px; color: white; border: 1px solid #555; cursor: pointer; border-radius: 5px; }
    </style>
</head>
<body>

    <div id="lobby" class="center-flex">
        <div class="ui-box">
            <h2 style="color:var(--primary); margin:0;">API STREAM</h2>
            <input type="text" id="urlInput" placeholder="Paste YouTube Link">
            <button class="btn" onclick="getLinkInfo()">Fetch Video</button>
            <div id="status" style="margin-top:10px; color:#aaa; font-size:12px;"></div>
        </div>
    </div>

    <div id="quality-screen" class="center-flex hidden">
        <div class="ui-box">
            <h3>Select Quality</h3>
            <div class="q-grid">
                <button class="q-btn" onclick="startStream('1080')">1080p</button>
                <button class="q-btn" onclick="startStream('720')">720p</button>
                <button class="q-btn" onclick="startStream('480')">480p</button>
                <button class="q-btn" onclick="startStream('360')">360p</button>
                <button class="q-btn" onclick="startStream('audio')">Audio Only</button>
            </div>
            <button class="btn" style="background:#333; margin-top:10px;" onclick="cancelQuality()">Cancel</button>
        </div>
    </div>

    <div id="progress-screen" class="center-flex hidden">
        <div class="ui-box">
            <h3>Downloading on Server...</h3>
            <div class="progress-container">
                <div id="progress-fill" class="progress-fill"></div>
            </div>
            <div id="percent-text">0%</div>
            <p style="color:#aaa; font-size:12px; margin-top:10px;">Converting & Processing...</p>
        </div>
    </div>

    <div id="link-screen" class="center-flex hidden">
        <div class="ui-box">
            <i class="fas fa-check-circle" style="color:var(--primary); font-size:50px; margin-bottom:15px;"></i>
            <h3>Stream Ready!</h3>
            <input type="text" id="share-link-input" readonly onclick="this.select()">
            <button class="btn" style="background:#333; border:1px solid #555;" onclick="copyLink()">Copy Link</button>
            <button class="btn" onclick="enterCinema()">Open Player</button>
        </div>
    </div>

    <div id="player-container" class="hidden">
        <div id="glass-shield"></div>
        <video id="player" playsinline crossorigin></video>
        <div id="mic-btn" onclick="toggleMic()"><i class="fas fa-microphone-slash"></i></div>
        
        <div id="admin-bar" class="admin-only">
            <button class="btn" onclick="apiControl('seek', -10)">‚è™</button>
            <button class="btn" onclick="apiControl('toggle')">‚èØÔ∏è</button>
            <button class="btn" onclick="apiControl('seek', 10)">‚è©</button>
            <button class="btn" onclick="copyLink()">üîó</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
    <script>
        const socket = io();
        const urlParams = new URLSearchParams(window.location.search);
        let roomId = urlParams.get('room');
        let player, amIAdmin = false;
        let currentUrl = '';

        if(roomId) {
            showScreen('player-container');
            socket.emit('join_room', roomId);
        } else {
            roomId = Math.random().toString(36).substring(7);
        }

        function showScreen(id) {
            document.querySelectorAll('body > div').forEach(d => d.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        function getLinkInfo() {
            const url = document.getElementById('urlInput').value;
            if(!url) return;
            document.getElementById('status').innerText = "Connecting...";
            socket.emit('get_info', { url });
        }

        socket.on('info_result', (data) => {
            currentUrl = data.url;
            showScreen('quality-screen');
        });

        function startStream(q) {
            showScreen('progress-screen');
            socket.emit('start_download', { roomId, url: currentUrl, quality: q });
        }

        function cancelQuality() { showScreen('lobby'); }

        socket.on('download_progress', (data) => {
            document.getElementById('progress-fill').style.width = data.percent + '%';
            document.getElementById('percent-text').innerText = Math.floor(data.percent) + '%';
        });

        socket.on('download_complete', (data) => {
            if(amIAdmin) {
                document.getElementById('share-link-input').value = window.location.href + `?room=${roomId}`;
                showScreen('link-screen');
            } else {
                initPlayer(data.filename);
            }
        });

        function enterCinema() { window.location.href = `?room=${roomId}`; }

        socket.on('inject_state', (data) => {
            amIAdmin = data.isAdmin;
            if(amIAdmin) document.body.classList.add('is-admin');
            if(data.filename) {
                showScreen('player-container');
                initPlayer(data.filename);
                player.once('ready', () => {
                    player.currentTime = data.time;
                    if(data.isPlaying) player.play();
                });
            }
        });

        function initPlayer(filename) {
            if(player) return;
            player = new Plyr('#player', { controls: [], clickToPlay: false, ratio: '16:9' });
            player.source = { type: 'video', sources: [{ src: `/stream/${filename}`, type: 'video/mp4' }] };
        }

        function apiControl(type, val) {
            let action = '', time = player.currentTime;
            if(type === 'toggle') action = player.paused ? 'play' : 'pause';
            else if (type === 'seek') { action = 'seek'; time += val; }
            fetch(`/api/room/${roomId}/control`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action, time })
            });
        }

        socket.on('force_sync', (data) => {
            if(data.action === 'play') player.play();
            if(data.action === 'pause') player.pause();
            if(data.action === 'seek') player.currentTime = data.time;
        });

        socket.on('status_msg', (msg) => alert(msg));
        function copyLink() { navigator.clipboard.writeText(window.location.href); alert("Copied"); }

        // AUDIO
        let audioCtx, processor, source, isMicOn = false;
        function toggleMic() {
            const btn = document.getElementById('mic-btn');
            if(isMicOn) {
                if(source) source.disconnect(); if(processor) processor.disconnect();
                isMicOn = false; btn.classList.remove('active');
            } else {
                navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    source = audioCtx.createMediaStreamSource(stream);
                    processor = audioCtx.createScriptProcessor(4096, 1, 1);
                    source.connect(processor);
                    processor.connect(audioCtx.destination);
                    processor.onaudioprocess = (e) => {
                        const inputData = e.inputBuffer.getChannelData(0);
                        const buffer = new ArrayBuffer(inputData.length * 2);
                        const outputView = new DataView(buffer);
                        for (let i = 0; i < inputData.length; i++) {
                            let s = Math.max(-1, Math.min(1, inputData[i]));
                            outputView.setInt16(i * 2, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
                        }
                        socket.emit('audio_stream', { roomId, audioChunk: buffer });
                    };
                    isMicOn = true; btn.classList.add('active');
                });
            }
        }
        socket.on('global_voice', (buf) => playAudioChunk(buf));
        function playAudioChunk(buffer) {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const int16 = new Int16Array(buffer);
            const float32 = new Float32Array(int16.length);
            for(let i=0; i<int16.length; i++) float32[i] = int16[i] / (int16[i] < 0 ? 0x8000 : 0x7FFF);
            const audioBuffer = audioCtx.createBuffer(1, float32.length, audioCtx.sampleRate);
            audioBuffer.getChannelData(0).set(float32);
            const s = audioCtx.createBufferSource(); s.buffer = audioBuffer; s.connect(audioCtx.destination); s.start();
        }
    </script>
</body>
</html>
