<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cinema PRO</title>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #e50914; --dark: #000; --gray: #1a1a1a; --text: #fff; }
        body { background-color: var(--dark); color: var(--text); font-family: sans-serif; margin: 0; height: 100vh; overflow: hidden; }
        .hidden { display: none !important; }
        
        .center-screen { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; width: 100%; }
        
        .box { background: var(--gray); padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; text-align: center; border: 1px solid #333; }
        input { width: 100%; padding: 12px; margin: 15px 0; background: #111; border: 1px solid #444; color: white; border-radius: 5px; }
        .btn { background: var(--primary); color: white; border: none; padding: 12px 20px; cursor: pointer; width: 100%; border-radius: 5px; font-weight: bold; margin-top: 5px; }
        
        /* Quality Modal */
        #quality-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 200; display: flex; align-items: center; justify-content: center; }
        .q-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .q-btn { background: #333; color: white; border: 1px solid #555; padding: 15px; cursor: pointer; border-radius: 5px; transition: 0.2s; }
        .q-btn:hover { background: var(--primary); border-color: var(--primary); }

        #player-screen { height: 100%; width: 100%; position: relative; }
        video { width: 100%; height: 100%; }
        #glass-shield { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; display: none; }
        body:not(.is-admin) #glass-shield { display: block; }
    </style>
</head>
<body>

    <div id="lobby-screen" class="center-screen">
        <div class="box">
            <h2>üé¨ PRO Download Engine</h2>
            <input type="text" id="linkInput" placeholder="Paste YouTube Link...">
            <button class="btn" onclick="fetchInfo()">Get Video</button>
            <p id="status-text" style="color:#aaa; font-size:12px; margin-top:10px;"></p>
        </div>
    </div>

    <div id="quality-modal" class="hidden">
        <div class="box">
            <h3 id="vid-title">Select Quality</h3>
            <img id="vid-thumb" src="" style="width:100%; border-radius:5px; margin-bottom:10px;">
            <div class="q-grid">
                <button class="q-btn" onclick="selectQuality('2160')">4K (Ultra)</button>
                <button class="q-btn" onclick="selectQuality('1080')">1080p (FHD)</button>
                <button class="q-btn" onclick="selectQuality('720')">720p (HD)</button>
                <button class="q-btn" onclick="selectQuality('480')">480p (SD)</button>
                <button class="q-btn" onclick="selectQuality('360')">360p (Data Saver)</button>
                <button class="q-btn" onclick="selectQuality('audio')">Audio Only</button>
            </div>
            <button class="btn" onclick="closeModal()" style="background:#444; margin-top:15px;">Cancel</button>
        </div>
    </div>

    <div id="player-screen" class="hidden">
        <div id="glass-shield"></div>
        <video id="player" playsinline controls></video>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
    <script>
        const socket = io();
        const urlParams = new URLSearchParams(window.location.search);
        let roomId = urlParams.get('room');
        let player, amIAdmin = false, isSyncing = false;
        let currentUrl = '';

        if (roomId) {
            document.getElementById('lobby-screen').classList.add('hidden');
            socket.emit('join_room', roomId);
        }

        // --- Step 1: Request Info ---
        function fetchInfo() {
            const link = document.getElementById('linkInput').value;
            if(!link) return alert("Enter Link");
            
            document.getElementById('status-text').innerText = "Fetching Formats...";
            
            // Generate Room ID if new
            if(!roomId) {
                roomId = Math.random().toString(36).substring(7);
                window.history.pushState({}, '', `?room=${roomId}`);
                socket.emit('join_room', roomId);
            }
            
            // Ask Server for Info
            socket.emit('get_video_info', { roomId, url: link });
        }

        // --- Step 2: Show Quality Menu ---
        socket.on('show_quality_menu', (data) => {
            currentUrl = data.url;
            document.getElementById('vid-title').innerText = data.title.substring(0, 30) + "...";
            document.getElementById('vid-thumb').src = data.thumbnail;
            document.getElementById('quality-modal').classList.remove('hidden');
            document.getElementById('status-text').innerText = "";
        });

        // --- Step 3: User Selected Quality ---
        function selectQuality(quality) {
            document.getElementById('quality-modal').classList.add('hidden');
            document.getElementById('lobby-screen').classList.add('hidden');
            document.getElementById('player-screen').classList.remove('hidden');
            
            // Show Loading...
            const box = document.createElement('div');
            box.id = 'loading-overlay';
            box.style = 'position:absolute;top:0;left:0;width:100%;height:100%;background:black;color:white;display:flex;justify-content:center;align-items:center;z-index:100;';
            box.innerHTML = '<h2>‚¨áÔ∏è Downloading on Server...</h2>';
            document.body.appendChild(box);

            socket.emit('start_download', { roomId, url: currentUrl, quality: quality });
        }

        function closeModal() {
            document.getElementById('quality-modal').classList.add('hidden');
        }

        // --- Step 4: Download Complete -> Play ---
        socket.on('download_complete', (data) => {
            const overlay = document.getElementById('loading-overlay');
            if(overlay) overlay.remove();

            initPlayer(data.filename);
        });

        socket.on('processing_msg', (msg) => {
             const stat = document.getElementById('status-text');
             if(stat) stat.innerText = msg;
        });
        
        socket.on('error_msg', (msg) => alert(msg));

        // --- Player Logic ---
        function initPlayer(filename) {
            player = new Plyr('#player', { controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'fullscreen'] });
            player.source = { type: 'video', sources: [{ src: `/stream/${filename}`, type: 'video/mp4' }] };
            
            // Sync Events
            player.on('play', () => { if(amIAdmin && !isSyncing) socket.emit('video_action', { roomId, type: 'play' }); });
            player.on('pause', () => { if(amIAdmin && !isSyncing) socket.emit('video_action', { roomId, type: 'pause' }); });
            player.on('seeked', () => { if(amIAdmin && !isSyncing) socket.emit('video_action', { roomId, type: 'seek', time: player.currentTime }); });

            setInterval(() => { if(amIAdmin && !player.paused) socket.emit('time_update', { roomId, time: player.currentTime }); }, 2000);
        }

        socket.on('update_room_data', (room) => {
            amIAdmin = room.admins.includes(socket.id);
            if(amIAdmin) document.body.classList.add('is-admin');
            
            if(room.status === 'ready' && !player) {
                // Late joiner logic
                document.getElementById('lobby-screen').classList.add('hidden');
                document.getElementById('player-screen').classList.remove('hidden');
                initPlayer(room.videoFilename);
            }
        });
        
        socket.on('perform_action', (data) => {
            isSyncing = true;
            if (data.type === 'play') player.play();
            else if (data.type === 'pause') player.pause();
            else if (data.type === 'seek') player.currentTime = data.time;
            setTimeout(() => isSyncing = false, 500);
        });
    </script>
</body>
</html>
